<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>DOE Visualizer</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.11.0/math.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    .top-section {
      display: flex;
      gap: 20px;
      align-items: flex-start;
    }
    #equation-result {
      margin-top: 20px;
      padding: 10px;
      border: 1px solid black;
      font-weight: bold;
      white-space: pre-wrap;
    }
    table {
      border-collapse: collapse;
    }
    td, th {
      border: 1px solid black;
      padding: 5px 10px;
      text-align: center;
    }
    #paretoChart {
      width: 300px !important;
      height: 180px !important;
      background-color: white;
    }
    #contourPlot {
      width: 400px;
      height: 400px;
    }
    .bottom-section {
      margin-top: 30px;
      display: flex;
      gap: 40px;
      justify-content: center;
      flex-wrap: wrap;
    }
    .plot-wrapper {
      width: 400px;
    }
    #plots-title {
      text-align: center;
      font-weight: bold;
      font-size: 1.2em;
      margin-top: 30px;
      margin-bottom: 10px;
    }
  </style>
</head>
<body>
  <h2>Design of Experiments - Input</h2>

  <div class="top-section">
    <!-- Input Table -->
    <div>
      <table>
        <thead>
          <tr><th>X1</th><th>X2</th><th>Y</th></tr>
        </thead>
        <tbody id="input-rows"></tbody>
      </table>
      <button onclick="calculate()">Calculate</button>
    </div>

    <!-- Parental Chart -->
    <div>
      <canvas id="paretoChart"></canvas>
      <div style="text-align:center; font-weight:bold; margin-top:8px;">Parental Chart (Pareto)</div>
    </div>

    <!-- Contour Plot -->
    <div>
      <div id="contourPlot"></div>
      <div style="text-align:center; font-weight:bold; margin-top:8px;">Contour Plot of Y(X1, X2)</div>
    </div>
  </div>

  <!-- Equation below top row -->
  <div id="equation-result"></div>

  <!-- Title above main/interaction plots -->
  <div id="plots-title">Main and Interaction Effects</div>

  <!-- Main and Interaction plots below -->
  <div class="bottom-section">
    <div class="plot-wrapper">
      <canvas id="mainEffectPlotX1"></canvas>
    </div>
    <div class="plot-wrapper">
      <canvas id="mainEffectPlotX2"></canvas>
    </div>
    <div class="plot-wrapper">
      <canvas id="interactionPlotX1"></canvas>
    </div>
    <div class="plot-wrapper">
      <canvas id="interactionPlotX2"></canvas>
    </div>
  </div>

<script>
  const X1_full = [-1, 1, -1, 1];
  const X2_full = [-1, -1, 1, 1];
  const defaultY = [1, 2, 3, 8];

  const X1_values = [-1, 1];
  const X2_values = [-1, 1];

  let paretoChart, mainEffectPlotX1, mainEffectPlotX2, interactionPlotX1, interactionPlotX2;

  window.onload = () => {
    const tbody = document.getElementById('input-rows');
    for (let i = 0; i < 4; i++) {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${X1_full[i]}</td>
        <td>${X2_full[i]}</td>
        <td><input type="number" id="Y${i}" value="${defaultY[i]}" style="width: 60px" /></td>
      `;
      tbody.appendChild(row);
    }
    calculate();
  };

  // Calculate coefficients for 2^2 full factorial (Intercept, X1, X2, X1*X2)
  function getCoefficients(Y) {
    const n = Y.length;
    // Using contrast method for full factorial 2^2 design
    // Intercept:
    const b0 = math.mean(Y);
    // Effects:
    // b1 = (Y1 - Y2 + Y3 - Y4)/4
    // b2 = (Y1 + Y2 - Y3 - Y4)/4
    // b12= (Y1 - Y2 - Y3 + Y4)/4
    const b1 = (Y[0] - Y[1] + Y[2] - Y[3]) / 4;
    const b2 = (Y[0] + Y[1] - Y[2] - Y[3]) / 4;
    const b12= (Y[0] - Y[1] - Y[2] + Y[3]) / 4;
    return [b0, b1, b2, b12];
  }

  // Calculate Y from coefficients and inputs
  function calculate_Y(coefficients, x1, x2) {
    // x1 and x2 can be scalars or arrays
    if (Array.isArray(x1) && Array.isArray(x2)) {
      return x1.map((v,i) => coefficients[0] + coefficients[1]*x1[i] + coefficients[2]*x2[i] + coefficients[3]*x1[i]*x2[i]);
    } else if (Array.isArray(x1)) {
      return x1.map(v => coefficients[0] + coefficients[1]*v + coefficients[2]*x2 + coefficients[3]*v*x2);
    } else if (Array.isArray(x2)) {
      return x2.map(v => coefficients[0] + coefficients[1]*x1 + coefficients[2]*v + coefficients[3]*x1*v);
    } else {
      return coefficients[0] + coefficients[1]*x1 + coefficients[2]*x2 + coefficients[3]*x1*x2;
    }
  }

  function calculate() {
    const Y = [0,0,0,0].map((_,i) => parseFloat(document.getElementById("Y"+i).value));
    const coefficients = getCoefficients(Y);

    document.getElementById("equation-result").textContent =
      `Estimated Equation:\nY = ${coefficients.map((c,i) =>
        `${i === 0 ? '' : ' + '}${c.toFixed(2)}${['', '·X1', '·X2', '·X1·X2'][i]}`
      ).join('')}`;

    // Parental Chart (Pareto) horizontal bars
    if (paretoChart) paretoChart.destroy();
    paretoChart = new Chart(document.getElementById("paretoChart"), {
      type: "bar",
      data: {
        labels: ["X1", "X2", "X1·X2"],
        datasets: [{
          label: "Effect",
          data: coefficients.slice(1).map(Math.abs),
          backgroundColor: "gray"
        }]
      },
      options: {
        responsive: true,
        indexAxis: 'y',
        plugins: {
          legend: { display: false }
        },
        scales: {
          x: { beginAtZero: true }
        }
      }
    });

    // Contour plot for Y(X1, X2)
    const gridPoints = 50;
    let x1grid = [], x2grid = [], zgrid = [];
    for(let i=0; i<gridPoints; i++) {
      x1grid.push(-1 + 2*i/(gridPoints-1));
      x2grid.push(-1 + 2*i/(gridPoints-1));
    }
    for(let i=0; i<gridPoints; i++) {
      let row = [];
      for(let j=0; j<gridPoints; j++) {
        row.push(calculate_Y(coefficients, x1grid[j], x2grid[i]));
      }
      zgrid.push(row);
    }

    Plotly.newPlot('contourPlot', [{
      z: zgrid,
      x: x1grid,
      y: x2grid,
      type: 'contour',
      colorscale: 'Viridis',
      contours: { coloring: 'heatmap' }
    }], {
      margin: { t: 20 },
      xaxis: { title: 'X1' },
      yaxis: { title: 'X2', scaleanchor: 'x', scaleratio: 1 }
    });

    // Main effect plots
    // Calculate Y for X1 (fix X2 = -1 and 1)
    const Y_X1_at_X2_neg1 = calculate_Y(coefficients, X1_values, -1);
    const Y_X1_at_X2_pos1 = calculate_Y(coefficients, X1_values, 1);
    // Calculate Y for X2 (fix X1 = -1 and 1)
    const Y_X2_at_X1_neg1 = calculate_Y(coefficients, -1, X2_values);
    const Y_X2_at_X1_pos1 = calculate_Y(coefficients, 1, X2_values);

    // Interaction plots (same as main but separate canvas)
    // Y vs X1 at X2 = -1 and 1
    const Y_int_X1_at_X2_neg1 = Y_X1_at_X2_neg1;
    const Y_int_X1_at_X2_pos1 = Y_X1_at_X2_pos1;
    // Y vs X2 at X1 = -1 and 1
    const Y_int_X2_at_X1_neg1 = Y_X2_at_X1_neg1;
    const Y_int_X2_at_X1_pos1 = Y_X2_at_X1_pos1;

    // Plot mainEffectPlotX1
    if(mainEffectPlotX1) mainEffectPlotX1.destroy();
    mainEffectPlotX1 = new Chart(document.getElementById("mainEffectPlotX1"), {
      type: 'line',
      data: {
        labels: X1_values,
        datasets: [
          {label: 'X2 = -1', data: Y_X1_at_X2_neg1, borderColor: 'blue', backgroundColor: 'blue', fill:false, tension:0.1, pointStyle:'circle', pointRadius:5},
          {label: 'X2 = 1', data: Y_X1_at_X2_pos1, borderColor: 'green', backgroundColor: 'green', fill:false, tension:0.1, pointStyle:'circle', pointRadius:5},
        ]
      },
      options: {
        responsive: true,
        scales: {
          y: {
            beginAtZero: false,
            title: {
              display: true,
              text: "Y for main effect"
            }
          },
          x: {
            title: {
              display: true,
              text: "X1"
            },
            ticks: {
              callback: v => v.toString()
            }
          }
        }
      }
    });

    // Plot mainEffectPlotX2
    if(mainEffectPlotX2) mainEffectPlotX2.destroy();
    mainEffectPlotX2 = new Chart(document.getElementById("mainEffectPlotX2"), {
      type: 'line',
      data: {
        labels: X2_values,
        datasets: [
          {label: 'X1 = -1', data: Y_X2_at_X1_neg1, borderColor: 'blue', backgroundColor: 'blue', fill:false, tension:0.1, pointStyle:'circle', pointRadius:5},
          {label: 'X1 = 1', data: Y_X2_at_X1_pos1, borderColor: 'green', backgroundColor: 'green', fill:false, tension:0.1, pointStyle:'circle', pointRadius:5},
        ]
      },
      options: {
        responsive: true,
        scales: {
          y: {
            beginAtZero: false,
            title: {
              display: true,
              text: "Y for main effect"
            }
          },
          x: {
            title: {
              display: true,
              text: "X2"
            },
            ticks: {
              callback: v => v.toString()
            }
          }
        }
      }
    });

    // Plot interactionPlotX1
    if(interactionPlotX1) interactionPlotX1.destroy();
    interactionPlotX1 = new Chart(document.getElementById("interactionPlotX1"), {
      type: 'line',
      data: {
        labels: X1_values,
        datasets: [
          {label: 'X2 = -1', data: Y_int_X1_at_X2_neg1, borderColor: 'blue', backgroundColor: 'blue', fill:false, tension:0.1, pointStyle:'circle', pointRadius:5},
          {label: 'X2 = 1', data: Y_int_X1_at_X2_pos1, borderColor: 'green', backgroundColor: 'green', fill:false, tension:0.1, pointStyle:'circle', pointRadius:5},
        ]
      },
      options: {
        responsive: true,
        scales: {
          y: {
            beginAtZero: false,
            title: {
              display: true,
              text: "Y"
            }
          },
          x: {
            title: {
              display: true,
              text: "X1"
            },
            ticks: {
              callback: v => v.toString()
            }
          }
        }
      }
    });

    // Plot interactionPlotX2
    if(interactionPlotX2) interactionPlotX2.destroy();
    interactionPlotX2 = new Chart(document.getElementById("interactionPlotX2"), {
      type: 'line',
      data: {
        labels: X2_values,
        datasets: [
          {label: 'X1 = -1', data: Y_int_X2_at_X1_neg1, borderColor: 'blue', backgroundColor: 'blue', fill:false, tension:0.1, pointStyle:'circle', pointRadius:5},
          {label: 'X1 = 1', data: Y_int_X2_at_X1_pos1, borderColor: 'green', backgroundColor: 'green', fill:false, tension:0.1, pointStyle:'circle', pointRadius:5},
        ]
      },
      options: {
        responsive: true,
        scales: {
          y: {
            beginAtZero: false,
            title: {
              display: true,
              text: "Y"
            }
          },
          x: {
            title: {
              display: true,
              text: "X2"
            },
            ticks: {
              callback: v => v.toString()
            }
          }
        }
      }
    });
  }
</script>
</body>
</html>
